package com.coderzclub.controller;

import com.coderzclub.config.JwtUtil;
import com.coderzclub.dto.JwtResponse;
import com.coderzclub.dto.LoginRequest;
import com.coderzclub.dto.RegisterRequest;
import com.coderzclub.model.User;
import com.coderzclub.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Optional;
import java.util.Map;

@RestController
@RequestMapping("/api")
public class AuthController {
    @Autowired
    private UserService userService;
    
    @Autowired
    private JwtUtil jwtUtil;

    @PostMapping("/register")
    public ResponseEntity<?> register(@RequestBody RegisterRequest req) {
        try {
            System.out.println("Registration attempt for username: " + req.getUsername() + ", email: " + req.getEmail());
            // Use provided role if present, default to "user"
            String role = req.getRole() != null ? req.getRole() : "user";
            User user = userService.registerUser(req.getUsername(), req.getEmail(), req.getPassword(), role);
            System.out.println("User registered successfully: " + user.getUsername() + ", password hash: " + user.getPasswordHash());
            String token = jwtUtil.generateToken(user.getUsername(), user.getRole());
            return ResponseEntity.ok(new JwtResponse(token, user.getRole()));
        } catch (Exception e) {
            System.out.println("Registration failed: " + e.getMessage());
            return ResponseEntity.badRequest().body(e.getMessage());
        }
    }

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest req) {
        System.out.println("=== LOGIN DEBUG ===");
        System.out.println("Login endpoint hit successfully");
        System.out.println("Login attempt for username: " + req.getUsername());
        System.out.println("Password length: " + req.getPassword().length());
        
        Optional<User> userOpt = userService.findByUsername(req.getUsername());
        
        if (userOpt.isPresent()) {
            User user = userOpt.get();
            System.out.println("User found: " + user.getUsername());
            System.out.println("Stored password hash: " + user.getPasswordHash());
            System.out.println("User role: " + user.getRole());
            
            boolean passwordMatch = userService.checkPassword(req.getPassword(), user.getPasswordHash());
            System.out.println("Password match result: " + passwordMatch);
            
            if (passwordMatch) {
                String token = jwtUtil.generateToken(user.getUsername(), user.getRole());
                System.out.println("Generated token successfully");
                return ResponseEntity.ok(new JwtResponse(token, user.getRole()));
            } else {
                System.out.println("Password does not match");
                return ResponseEntity.status(401).body("Invalid credentials");
            }
        } else {
            System.out.println("User not found: " + req.getUsername());
            return ResponseEntity.status(401).body("Invalid credentials");
        }
    }

    @GetMapping("/test")
    public ResponseEntity<?> test() {
        System.out.println("Test endpoint hit");
        return ResponseEntity.ok("Backend is working!");
    }

    @PostMapping("/test-password")
    public ResponseEntity<?> testPassword(@RequestBody LoginRequest req) {
        System.out.println("=== PASSWORD TEST ===");
        System.out.println("Testing password: " + req.getPassword());
        
        // Test encoding
        String encoded = userService.getPasswordEncoder().encode(req.getPassword());
        System.out.println("Encoded password: " + encoded);
        
        // Test matching
        boolean matches = userService.checkPassword(req.getPassword(), encoded);
        System.out.println("Password matches: " + matches);
        
        // Test multiple encodings of same password
        String encoded2 = userService.getPasswordEncoder().encode(req.getPassword());
        System.out.println("Second encoding: " + encoded2);
        boolean matches2 = userService.checkPassword(req.getPassword(), encoded2);
        System.out.println("Second password matches: " + matches2);
        
        return ResponseEntity.ok(Map.of(
            "original", req.getPassword(),
            "encoded", encoded,
            "matches", matches,
            "encoded2", encoded2,
            "matches2", matches2
        ));
    }
} 